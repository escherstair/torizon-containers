stages:
  - build
  - test
  - report

build-tests-container:
  extends: .docker-build
  stage: build
  rules:
    - if: $CI_WORLD_TEST == "true" || $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
      changes:
        - /ci-scripts/test/*
        - tests/**/*
  variables:
    IMAGE_NAME: torizon-containers-tests
    DOCKERFILE_FOLDER: ./tests/
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "."
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_V7: "true"

.e2e-test-template:
  stage: test
  image: gitlab.int.toradex.com:4567/rd/torizon-core-containers/aval/aval:main
  before_script:
    - /usr/local/bin/entrypoint.sh "docker run -e REGISTRY=$TORADEX_INTERNAL_DOCKERHUB_CACHE -e SOC_UDT=$SOC_UDT -e RM_ON_TEARDOWN=$RM_ON_TEARDOWN --privileged --pid host
      -v /var/run/docker.sock:/var/run/docker.sock -v /home/torizon:/home/torizon -v /sys:/sys
      ${CI_REGISTRY}/${CI_PROJECT_PATH}/torizon-containers-tests:${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_ID} /cases/run-tests.sh"
      --copy-artifact /home/torizon/report.xml report.xml --delegation-config ./ci-scripts/test/delegation_config.toml
      --before "docker kill $(docker ps -q) || true && docker system prune --all --force" --ignore-different-secondaries-between-updates
  allow_failure: true
  script:
    - mv report.xml report-${CI_JOB_NAME}.xml
  variables:
    TARGET_BUILD_TYPE: "release"
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: on_success
  artifacts:
    when: always
    reports:
      junit: report-${CI_JOB_NAME}.xml
    paths:
      - ./report-${CI_JOB_NAME}.xml
  needs:
    - build-tests-container

e2e-test-colibri-imx7d-emmc-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "colibri-imx7d-emmc"

e2e-test-verdin-am62dual-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "verdin-am62dual"

e2e-test-apalis-imx6q-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "apalis-imx6q"

e2e-test-apalis-imx8qm-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "apalis-imx8qm"

e2e-test-colibri-imx8dx-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "colibri-imx8dx"

e2e-test-verdin-imx8mmq-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "verdin-imx8mmq"

e2e-test-verdin-imx8mpq-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "verdin-imx8mpq"

e2e-test-colibri-imx7d-emmc-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "colibri-imx7d-emmc"

e2e-test-colibri-imx8dx-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "colibri-imx8dx"

e2e-test-verdin-am62dual-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "verdin-am62dual"

e2e-test-apalis-imx6q-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "apalis-imx6q"

e2e-test-apalis-imx8qm-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "apalis-imx8qm"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
      changes:
        - /ci-scripts/test/*
        - tests/**/*
    - if: $CI_WORLD_TEST == "true"
      when: always

e2e-test-verdin-imx8mmq-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "verdin-imx8mmq"

e2e-test-verdin-imx8mpq-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "verdin-imx8mpq"

e2e-test-colibri-imx6dl-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "colibri-imx6dl"

e2e-test-colibri-imx6dl-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "colibri-imx6dl"

e2e-test-colibri-imx6ull-emmc-release:
  extends: .e2e-test-template
  variables:
    SOC_UDT: "colibri-imx6ull-emmc"

e2e-test-colibri-imx6ull-emmc-nightly:
  extends: .e2e-test-template
  variables:
    TARGET_BUILD_TYPE: "nightly"
    SOC_UDT: "colibri-imx6ull-emmc"

aggregate-reports:
  stage: report
  image: homebrew/brew
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: on_success
  script:
    - mkdir -p reports
    - mv *.xml reports/
    - brew tap homebrew-toradex/xray-junit-uploader https://gitlab.int.toradex.com/rd/torizon-core-containers/homebrew-toradex.git
    - brew install xray-junit-uploader
    - ./ci-scripts/test/xray-junit-uploader-wrapper.sh
  artifacts:
    paths:
      - reports/
  variables:
    VERDIN_IMX8MPQ_TEST_EXEC_KEY: "TCCP-934"
    VERDIN_AM62DUAL_TEST_EXEC_KEY: "TCCP-954"
    VERDIN_IMX8MMQ_TEST_EXEC_KEY: "TCCP-955"
    APALIS_IMX6Q_TEST_EXEC_KEY: "TCCP-956"
    APALIS_IMX8QM_TEST_EXEC_KEY: "TCCP-957"
    COLIBRI_IMX8DX_TEST_EXEC_KEY: "TCCP-958"
    COLIBRI_IMX7D_TEST_EXEC_KEY: "TCCP-953"
    COLIBRI_IMX6DL_TEST_EXEC_KEY: "TCCP-959"
    COLIBIR_IMX6ULL_TEST_EXEC_KEY: "TCPP-960"
    EVK_IMX95_TEST_EXEC_KEY: "TCCP-964"
    TORIZON_OS_TEST_PLAN_KEY: "TOR-3748"
    GIT_CLEAN_FLAGS: none
